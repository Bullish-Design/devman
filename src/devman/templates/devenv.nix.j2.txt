# src/devman/templates/devenv.nix.j2
# devenv.nix - {{name}}
{ pkgs, config, lib, ... }: {
  name = "{{name}}";
  
  languages.python = {
    enable = true;
    version = "{{python_version}}";
    uv.enable = true;
  };
  
  packages = with pkgs; [
    just
    git
{%if use_containers%}
    docker-compose
    skopeo
{%endif%}
{%if project_type == "ml"%}
    jupyter
{%endif%}
  ];

{%if container_type == "devenv"%}
  # Container generation via devenv
  containers.{{name}} = {
    name = "{{name}}";
    registry = "localhost:5000";
    copyToRoot = pkgs.buildEnv {
      name = "container-root";
      paths = with pkgs; [ python{{python_version_short}} git uv ];
    };
    config = {
{%if project_type == "api"%}
      Cmd = [ "uvicorn" "{{name}}.main:app" "--host" "0.0.0.0" "--reload" ];
      ExposedPorts = { "8000/tcp" = {}; };
{%endif%}
{%if project_type == "web"%}
      Cmd = [ "flask" "--app" "{{name}}.app:app" "run" "--host" "0.0.0.0" ];
      ExposedPorts = { "5000/tcp" = {}; };
{%endif%}
      Env = [
        "PYTHONPATH=/app/src"
        "UV_COMPILE_BYTECODE=1"
      ];
    };
  };
{%endif%}

  env = {
    PYTHONPATH = "${config.env.DEVENV_ROOT}/src";
{%if use_containers%}
    REGISTRY_URL = "localhost:5000";
{%endif%}
{%if use_database%}
    DATABASE_URL = "{{database_type}}://user:pass@localhost:5432/{{name}}";
{%endif%}
  };
  
  enterShell = ''
    echo "ðŸš€ {{name}} development environment"
    
    # Install dependencies
    if [ -f "pyproject.toml" ]; then
      uv sync
    fi
    
    echo "Available commands: just --list"
  '';
  
{%if use_database%}
  services.{{database_type}} = {
    enable = true;
    initialScript = "CREATE DATABASE IF NOT EXISTS {{name}};";
  };
{%endif%}

{%if use_redis%}
  services.redis.enable = true;
{%endif%}

{%if project_type == "api"%}
  processes.api.exec = "uv run fastapi dev src/{{name}}/main.py --host 0.0.0.0";
{%endif%}
{%if project_type == "web"%}
  processes.web.exec = "uv run flask --app src/{{name}}/app.py run --debug";
{%endif%}
{%if project_type == "ml"%}
  processes.jupyter.exec = "uv run jupyter lab --ip=0.0.0.0 --no-browser";
{%endif%}
}